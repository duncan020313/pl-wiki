## 1. 개요
[지향성 퍼징](https://github.com/prosyslab/pl-wiki/wiki/지향성-퍼징(Directed-Fuzzing)) 문서에서 보았듯이 지향성 퍼징 분야는 활발히 연구되고 있으며 다양한 접근들이 이루어지고 있다.
하지만 안타깝게도 신생 연구분야인 지향성 퍼징은 한동안 이렇다 할 만한 연구의 표준이 정리되지 않아 성능 평가가 일관되게 이루어지지 않고 있었다.
이러한 문제점을 극복하기 위한 노력의 일환으로 최근 지향성 퍼징 도구의 성능 평가의 기준이 제안되었고<sup>[1](#EvalDirFuzz)</sup> 그 내용은 다음과 같다.

지향성 퍼징 도구는 일반적으로 결함 재현 실험을 통해 성능을 평가한다.
결함 재현 실험은 알려진 결함을 얼마나 빨리 재현하는지를 평가하는 실험으로 다음과 같은 단계로 이루어진다.

- 목표 결함을 대표하는 프로그램 지점을 선정하여 지향성 퍼징 도구에 입력으로 전달하고, 주어진 시간동안 퍼징 도구를 실행한다.
- 실행이 종료되면 그 과정에서 찾은 결함들이 목표한 결함인지 확인한다.
- 확인된 결함들을 기록하고, 목표 결함을 재현하는데 걸린 시간을 기록한다.
- 결과의 신뢰성을 높이기 위해 이 과정을 일정한 횟수만큼 반복한다.
- 두 도구의 성능을 비교하기 위해 목표 결함을 재현하는데 걸린 시간의 중앙값을 비교하거나 보다 정교한 통계 검사를 한다.

위의 각 단계에서 어떤 선택을 하는지에 따라 성능 평가의 결과가 크게 달라질 수 있다. 구체적으로 각 단계에서 어떤 문제가 발생할 수 있으며 이를 방지하기 위해 어떤 노력을 해야 하는지 알아보자.

## 2. 목표 선정

결함 재현 실험은 보통 CVE(Common Vulnerabilities and Exposures)등의 알려진 결함을 목표 결함으로 사용한다.
하지만 하나의 CVE에 대해 어떤 목표 지점을 구체적으로 지향성 퍼징 도구에 전달해야 하는지는 명확하게 정해져 있지 않다.
실제로 같은 CVE에 근본적인 원인이 다른 두 결함이 묶여있을 수 있고, 결함이 발생한 경로 중 어떤 지점이 결함의 맥락을 가장 잘 나타내는지도 명확하지 않다.
문제는 이렇게 목표 지점이 달라지면 결함 재현 실험의 결과도 달라진다는 것이다.
따라서 여러 연구에 걸쳐 일관적인 평가를 위해서는 단순히 사용한 CVE 번호만을 공개하는 것이 아닌 실제 사용한 목표 지점을 공개해야 한다.

## 3. 목표 결함 확인

주어진 시간동안 발견된 결함들이 목표 결함인지 확인하는 방법에는 크게 두 가지가 있다.
먼저 프로그램 안전벨트(Sanitizer)를 사용하여 발견된 결함들을 검사하는 방법이 있다.
보통 프로그램 안전벨트는 발생한 결함의 종류와 스택 트레이스를 제공하는데, 이 정보가 목표 결함의 정보와 일치하는지를 확인하여 결함을 확인하는 것이다.
하지만 정보가 얼마나 일치하는지에 대한 기준이 명확하지 않다.
예를 들어 스택 트레이스가 모두 일치해야만 같은 결함일 수 있지만 결함 발생 지점만 일치해도 같은 결함인 경우도 있다. 심지어 결함 발생 지점이 다르더라도 같은 결함일 수도 있다.

좀 더 명확한 방법으로는 목표 결함을 수정하는 패치를 사용하는 방식이 있다.
즉, 발견된 결함을 유발하는 입력들이 패치가 적용된 프로그램에서 정상적으로 실행된다면 해당 결함은 목표 결함이라고 판단하는 것이다.
얼핏 확실한 방법처럼 보이지만, 이 또한 몇 가지 문제점을 가지고 있다.
먼저 어떤 패치가 목표 결함을 완전히 수정했는지를 판단하는 것이 어렵다.
왜냐하면 여러 패치에 걸쳐 하나의 결함이 수정될 수 있고, 하나의 패치가 여러 결함을 수정할 수도 있기 때문이다.
또한 이중으로 결함이 존재하는 경우, 패치가 적용된 프로그램에서 기존 결함은 사라지지만 새로운 결함이 발생할 수 있다.

따라서 일관적인 평가를 위해 최소한 구체적인 목표 결함 검사 방법을 공개해야 한다.
더 나아가 애초에 검사 로직이 포함된 벤치마크를 사용하는 것이 바람직하다.
예를 들어 목표 결함 검사문(assertion)이 삽입되어 있는 프로그램이나, 단 하나의 결함만 존재하도록 합성된 프로그램<sup>[2](#Fuzzle)</sup>이 여기에 해당한다.

## 4. 결함 발견 시간 측정

결함 발견 시간은 보통 TTE(Time To Exploit)으로 표기한다.
이 때 대부분의 연구는 퍼징 시간만 고려하여 TTE를 산출해내었다.
하지만 지향성 퍼징의 경우 유독 많은 도구들이 퍼징에 앞서 프로그램을 분석하고, 분석 결과를 이용하여 퍼징을 진행한다.
심지어 이 분석 시간이 퍼징 시간보다 더 오래 걸리는 경우도 있다.
프로그램 분석은 보통 프로그램이 수정될 때마다 새로 해야 하기 때문에 지속적인 개발 환경 등에서 지향성 퍼징을 활용하려면 이러한 분석 시간도 함께 고려되어야 한다.
따라서 분석 시간도 함께 공개하여 보다 다양한 측면에서 도구들을 비교할수 있도록 해야 한다.

## 5. 실험 반복 횟수

퍼징은 무작위성을 이용하여 입력을 생성하기 때문에 항상 조금씩 다른 결과가 나온다.
프로그램 내의 탐색 영역이 매번 달라질 수 있기 떄문이다.
따라서 퍼징 도구를 평가할 때는 실험을 여러 번 반복하여 그 결과의 신뢰성을 높인다.
여러 번의 실험을 반복하면 커버리지 달성률이나 발견된 결함의 갯수 등이 어느정도 수렴하기 때문이다.

하지만 지향성 퍼징의 경우 프로그램 전체에서 발생하는 커버리지나 결함의 갯수는 중요하지 않다.
왜냐하면 특정 지점에 도달하여 특정 결함을 재현하는 것이 목표이기 때문이다.
따라서 지향성 퍼징은 일반적인 퍼징보다 무작위성에 더욱 취약하여 더 많은 횟수의 실험을 필요로 한다.
실제로 최근 연구에서는 40회 이상의 실험을 반복하여 그 결과를 평가하였다.

## 6. 통계 검증

성능 평가의 최종 단계에서는 여러번 반복한 실험 결과를 통해 둘 이상의 퍼징도구의 성능을 비교해야 한다.
이런 성능 비교는 TTE의 중앙값을 비교하거나 Mann-Whitney U(MWU) 검사와 같은 보다 정확한 통계 검사를 하기도 한다.
하지만 지향성 퍼징의 경우 주어진 시간안에 목표 결함을 발견하지 못하는 타임 아웃이 발생할 수 있는데, MWU 검사는 근본적으로
이러한 데이터를 적절하게 처리할 수 없다.
따라서 이전 지향성 퍼징 연구는 예를 들어, 24시간 실험동안 목표 결함을 발견하지 못한 경우에 결함 발견 시간을 24시간으로 간주하는 방식으로 MWU 검사를 수행했다. 하지만 이는 타임 아웃이 발생한 퍼징 도구의 성능을 과대 평가하는 결과를 낳을 수 있기에 적절하지 않다.

지향성 퍼징의 경우, MWU 검사보다는 Log-rank 검사 등의 생존분석(survival analysis)을 사용하는 것이 바람직하다.
생존 분석의 경우 주어진 시간 내에 사건이 관찰되지 않는 경우도 처리할 수 있기에 타임 아웃이 발생하는 지향성 퍼징에 적합하기 때문이다.
특히 성능을 시각화 할수 있도록 선인장 그래프 (cactus plot)도 함께 사용한다면 금상첨화일 것이다.

## 7. 참고

[<a name="EvalDirFuzz">1</a>] "[Evaluating Directed Fuzzers: Are We Heading in the Right Direction?](https://prosys.kaist.ac.kr/publications/fse24.pdf)", Kim et al., FSE 2024

[<a name="Fuzzle">2</a>] "Fuzzle: Making a Puzzle for Fuzzers", Lee, Kim, and Cha, ASE 2022
